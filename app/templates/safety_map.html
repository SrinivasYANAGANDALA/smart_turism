{% extends "base.html" %}

{% block title %}Safety Map - TravelBuddy{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-map-marked-alt me-2 text-primary"></i>Safety Map</h2>
            <p class="text-muted">Real-time view of safety alerts and incidents reported by tourists.</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('dashboard.report_safety_alert') }}" class="btn btn-danger">
                <i class="fas fa-exclamation-circle me-2"></i>Report Incident
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Map Column -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-globe-asia me-2 text-success"></i>Live Safety View</h5>
                    <span class="badge bg-danger pulse-animation">{{ alerts|length }} Active Alerts</span>
                </div>
                <div class="card-body p-0">
                    <!-- Map Container -->
                    <div id="safetyMap" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Recent Alerts Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="fas fa-bell me-2 text-warning"></i>Recent Reports</h5>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        {% for alert in alerts %}
                        <a href="#" class="list-group-item list-group-item-action" onclick="focusOnMap({{ alert.lat }}, {{ alert.lng }})">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 text-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ alert.type|title }}
                                </h6>
                                <small class="text-muted">Just now</small>
                            </div>
                            <p class="mb-1 small">{{ alert.details }}</p>
                            <small class="text-primary"><i class="fas fa-map-marker-alt me-1"></i>View on Map</small>
                        </a>
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                            <p>No active safety alerts in your area.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
    .pulse-animation {
        animation: pulse-red 2s infinite;
    }
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
</style>

<script>
    var map;
    var markers = [];

    document.addEventListener('DOMContentLoaded', function() {
        // 1. Initialize Map (Default center: India)
        map = L.map('safetyMap').setView([20.5937, 78.9629], 5);

        // 2. Add OpenStreetMap Tile Layer (Free, no API key needed)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 3. Get Alerts Data from Backend Template
        var alertsData = {{ alerts|tojson|safe }};

        // 4. Custom Icons
        var alertIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // 5. Plot Markers
        if (alertsData && alertsData.length > 0) {
            var bounds = L.latLngBounds(); // To auto-zoom to fit all markers

            alertsData.forEach(function(alert) {
                if(alert.lat && alert.lng) {
                    var marker = L.marker([alert.lat, alert.lng], {icon: alertIcon})
                        .addTo(map)
                        .bindPopup(`
                            <div class="text-center">
                                <strong class="text-danger">${alert.type}</strong><br>
                                ${alert.details}<br>
                                <small class="text-muted">Reported Incident</small>
                            </div>
                        `);
                    
                    markers.push(marker);
                    bounds.extend([alert.lat, alert.lng]);
                }
            });

            // Auto-zoom map to show all alerts if any exist
            if (markers.length > 0) {
                map.fitBounds(bounds, {padding: [50, 50]});
            }
        } else {
            // If no alerts, try to center on user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    map.setView([lat, lng], 12);
                    
                    L.marker([lat, lng]).addTo(map)
                        .bindPopup("You are here").openPopup();
                });
            }
        }
    });

    // Function to fly to location when clicking sidebar list
    function focusOnMap(lat, lng) {
        if(map) {
            map.flyTo([lat, lng], 15, {
                duration: 1.5
            });
        }
    }
</script>
{% endblock %}
